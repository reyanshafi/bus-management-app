<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard | Bus Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Montserrat', Arial, sans-serif;
    }
    .sidebar {
      background: #0f766e;
      transition: all 0.3s ease;
      border-right: 1px solid #e5e7eb;
    }
    .nav-link {
      transition: all 0.2s ease;
      border-radius: 8px;
      color: #d1fae5;
      font-weight: 500;
    }
    .nav-link:hover {
      background-color: #134e4a;
      color: #f9fafb;
    }
    .nav-link.active {
      background-color: #14b8a6;
      color: #ffffff;
      font-weight: 600;
    }
    @media (max-width: 768px) {
      .sidebar { 
        transform: translateX(-100%); 
        position: fixed; 
        z-index: 50; 
        height: 100vh; 
      }
      .sidebar.active { 
        transform: translateX(0); 
      }
    }
    .sidebar.closed { 
      display: none !important; 
    }
    body.sidebar-closed .md\:ml-64 { 
      margin-left: 0 !important; 
    }
    
    /* Hide scrollbars */
    .scrollbar-hide {
      -ms-overflow-style: none;  /* Internet Explorer 10+ */
      scrollbar-width: none;  /* Firefox */
    }
    .scrollbar-hide::-webkit-scrollbar { 
      display: none;  /* Safari and Chrome */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <!-- Mobile Menu Button -->
  <button id="mobileMenuButton" class="md:hidden fixed top-4 left-4 z-50 bg-white p-3 rounded-lg shadow-lg border-2 border-blue-500" style="z-index: 9999;">
    <i class="fas fa-bars text-gray-700 text-lg"></i>
  </button>

  <!-- Sidebar Toggle Button (desktop only) -->
  <button id="sidebarToggleBtn" class="hidden md:block fixed top-6 left-6 z-50 bg-white p-2 rounded shadow-lg">
    <i class="fas fa-bars text-gray-700"></i>
  </button>

 <!-- Sidebar Navigation -->
<div class="sidebar bg-blue-900 text-white w-64 fixed h-full flex flex-col">
  <!-- Brand -->
  <div class="p-6 flex items-center justify-center border-b border-blue-800">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-teal-500 rounded-lg flex items-center justify-center">
        <i class="fas fa-user-shield text-white text-xl"></i>
      </div>
      <h1 class="text-2xl font-semibold">Admin Panel</h1>
    </div>
  </div>

  <!-- Nav Links -->
  <nav class="flex-1 overflow-y-auto px-2 py-4 space-y-1">
    <a href="#dashboard"
       class="nav-link group flex items-center px-4 py-2 rounded-lg transition relative
              hover:bg-blue-800"
       data-name="dashboard">
      <span class="absolute left-0 inset-y-0 w-1 rounded-l-lg bg-transparent group-hover:bg-teal-400 transition-colors"></span>
      <i class="fas fa-tachometer-alt w-5 text-lg"></i>
      <span class="ml-3">Dashboard</span>
    </a>

    <a href="#buses"
       class="nav-link group flex items-center px-4 py-2 rounded-lg transition relative
              hover:bg-blue-800"
       data-name="buses">
      <span class="absolute left-0 inset-y-0 w-1 rounded-l-lg bg-transparent group-hover:bg-teal-400 transition-colors"></span>
      <i class="fas fa-bus w-5 text-lg"></i>
      <span class="ml-3">Bus Management</span>
    </a>

    <a href="#assignments"
       class="nav-link group flex items-center px-4 py-2 rounded-lg transition relative
              hover:bg-blue-800"
       data-name="assignments">
      <span class="absolute left-0 inset-y-0 w-1 rounded-l-lg bg-transparent group-hover:bg-teal-400 transition-colors"></span>
      <i class="fas fa-tasks w-5 text-lg"></i>
      <span class="ml-3">Bus Assignments</span>
    </a>

    <a href="#routes"
       class="nav-link group flex items-center px-4 py-2 rounded-lg transition relative
              hover:bg-blue-800"
       data-name="routes">
      <span class="absolute left-0 inset-y-0 w-1 rounded-l-lg bg-transparent group-hover:bg-teal-400 transition-colors"></span>
      <i class="fas fa-route w-5 text-lg"></i>
      <span class="ml-3">Route Management</span>
    </a>

    <a href="#stops"
       class="nav-link group flex items-center px-4 py-2 rounded-lg transition relative
              hover:bg-blue-800"
       data-name="stops">
      <span class="absolute left-0 inset-y-0 w-1 rounded-l-lg bg-transparent group-hover:bg-teal-400 transition-colors"></span>
      <i class="fas fa-map-marker-alt w-5 text-lg"></i>
      <span class="ml-3">Stop Management</span>
    </a>

    <a href="#feedback"
       class="nav-link group flex items-center px-4 py-2 rounded-lg transition relative
              hover:bg-blue-800"
       data-name="feedback">
      <span class="absolute left-0 inset-y-0 w-1 rounded-l-lg bg-transparent group-hover:bg-teal-400 transition-colors"></span>
      <i class="fas fa-comments w-5 text-lg"></i>
      <span class="ml-3">Student Feedback</span>
    </a>

    <a href="#notifications"
       class="nav-link group flex items-center px-4 py-2 rounded-lg transition relative
              hover:bg-blue-800"
       data-name="notifications">
      <span class="absolute left-0 inset-y-0 w-1 rounded-l-lg bg-transparent group-hover:bg-teal-400 transition-colors"></span>
      <i class="fas fa-bell w-5 text-lg"></i>
      <span class="ml-3">Notifications</span>
    </a>

    <a href="#students"
       class="nav-link group flex items-center px-4 py-2 rounded-lg transition relative
              hover:bg-blue-800"
       data-name="students">
      <span class="absolute left-0 inset-y-0 w-1 rounded-l-lg bg-transparent group-hover:bg-teal-400 transition-colors"></span>
      <i class="fas fa-user-graduate w-5 text-lg"></i>
      <span class="ml-3">Student Management</span>
    </a>
  </nav>

  <!-- Logout -->
  <div class="px-4 py-4 border-t border-blue-800">
    <a href="#" id="logoutBtn"
       class="flex items-center px-4 py-2 rounded-lg text-red-300 hover:text-red-100 hover:bg-blue-800 transition">
      <i class="fas fa-sign-out-alt w-5"></i>
      <span class="ml-3">Logout</span>
    </a>
  </div>

  <!-- Footer -->
  <div class="px-4 py-2 border-t border-blue-800 text-center">
    <p class="text-xs text-blue-400">Admin Portal v2.0</p>
    <p class="text-xs text-blue-500">Â© 2023 University Transport</p>
  </div>
</div>

<!-- Optional JavaScript to set the active link -->
<script>
  // Example: highlight based on URL hash
  const current = location.hash.substring(1) || 'dashboard';
  document.querySelectorAll('.nav-link').forEach(link => {
    if (link.dataset.name === current) {
      // add background + accent
      link.classList.add('bg-blue-800');
      link.querySelector('span').classList.add('text-teal-300');
      link.querySelector('.absolute').classList.replace('bg-transparent','bg-teal-400');
    }
  });
</script>


  <!-- Main Content -->
  <div class="md:ml-64 p-4 md:p-6">
    <!-- Header -->
    <header class="bg-white rounded-lg shadow p-4 mb-6 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-gray-800" id="sectionTitle">Dashboard</h1>
      <div class="flex items-center space-x-4">
        <div class="hidden md:block text-right">
          <p class="text-sm font-medium" id="adminName">Admin</p>
          <p class="text-xs text-gray-500" id="adminEmail">Loading...</p>
        </div>
      </div>
    </header>

    <!-- Dashboard Content -->
<div class="space-y-8">
  <!-- Dashboard Overview -->
  <div id="dashboardSection" class="section-content">
    <!-- Stats Grid - Equally Spaced -->
    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
      <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <p class="text-blue-100 text-sm font-medium mb-2">Total Students</p>
            <p id="totalStudents" class="text-3xl font-bold">0</p>
          </div>
          <div class="bg-white/20 backdrop-blur-sm rounded-xl p-3 ml-4">
            <i class="fas fa-users text-2xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <p class="text-emerald-100 text-sm font-medium mb-2">Active Buses</p>
            <p id="activeBuses" class="text-3xl font-bold">0</p>
          </div>
          <div class="bg-white/20 backdrop-blur-sm rounded-xl p-3 ml-4">
            <i class="fas fa-bus text-2xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-cyan-600 to-cyan-800 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <p class="text-cyan-100 text-sm font-medium mb-2">Routes</p>
            <p id="totalRoutes" class="text-3xl font-bold">0</p>
          </div>
          <div class="bg-white/20 backdrop-blur-sm rounded-xl p-3 ml-4">
            <i class="fas fa-route text-2xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-amber-600 to-amber-800 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <p class="text-amber-100 text-sm font-medium mb-2">New Feedback</p>
            <p id="newFeedback" class="text-3xl font-bold">0</p>
          </div>
          <div class="bg-white/20 backdrop-blur-sm rounded-xl p-3 ml-4">
            <i class="fas fa-comments text-2xl"></i>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Recent Activity Card -->
    <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
      <div class="flex items-center gap-3 mb-6">
        <div class="bg-teal-100 rounded-xl p-3">
          <i class="fas fa-history text-teal-600 text-xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-900">Recent Activity</h2>
      </div>
      <div id="recentActivity" class="space-y-4">
        <div class="flex items-center justify-center py-8 text-gray-400">
          <i class="fas fa-spinner fa-spin mr-3"></i>
          <span>Loading activity...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Live Dashboard Grid - Equal Layout -->
  <div id="liveDashboardGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Live Feedback Feed -->
    <div class="bg-gradient-to-br from-blue-900 via-blue-800 to-blue-700 rounded-2xl shadow-2xl p-8 text-white transform transition-all duration-500 hover:scale-105">
      <div class="flex items-center gap-4 mb-6">
        <div class="bg-blue-500/30 backdrop-blur-sm rounded-xl p-3 animate-pulse">
          <i class="fas fa-comments text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold">Live Feedback Feed</h3>
      </div>
      <div id="liveFeedbackFeed" class="space-y-3 min-h-[200px]">
        <div class="flex items-center justify-center py-12 text-blue-200">
          <i class="fas fa-spinner fa-spin mr-3"></i>
          <span>Loading feedback...</span>
        </div>
      </div>
    </div>
    
    <!-- Live Notifications -->
    <div class="bg-gradient-to-br from-emerald-900 via-emerald-800 to-emerald-700 rounded-2xl shadow-2xl p-8 text-white transform transition-all duration-500 hover:scale-105">
      <div class="flex items-center gap-4 mb-6">
        <div class="bg-emerald-500/30 backdrop-blur-sm rounded-xl p-3 animate-pulse">
          <i class="fas fa-bell text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold">Live Notifications</h3>
      </div>
      <div id="liveNotificationsFeed" class="space-y-3 min-h-[200px]">
        <div class="flex items-center justify-center py-12 text-emerald-200">
          <i class="fas fa-spinner fa-spin mr-3"></i>
          <span>Loading notifications...</span>
        </div>
      </div>
    </div>
  </div>
</div>

      <!-- Bus Management Section -->
<div id="busesSection" class="section-content hidden space-y-8">
  <!-- Add New Bus Card -->
  <div class="rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-green-100 rounded-xl p-3">
        <i class="fas fa-plus text-green-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Add New Bus</h2>
    </div>
    
    <form id="busForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="busNumber" class="block text-sm font-semibold text-gray-700 mb-2">Bus Number</label>
          <input type="text" id="busNumber" placeholder="Enter bus number" required 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
        </div>
        
        <div>
          <label for="busRouteSelect" class="block text-sm font-semibold text-gray-700 mb-2">Route</label>
          <select id="busRouteSelect" required 
                  class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
            <option value="">Select Route</option>
            <!-- Route options will be populated by JS -->
          </select>
        </div>
        
        <div>
          <label for="departure" class="block text-sm font-semibold text-gray-700 mb-2">Departure Time</label>
          <input type="time" id="departure" required 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
        </div>
        
        <div>
          <label for="seatsTotal" class="block text-sm font-semibold text-gray-700 mb-2">Total Seats</label>
          <input type="number" id="seatsTotal" placeholder="Enter total seats" required 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
        </div>
      </div>
      
      <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 flex items-center justify-center gap-3 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
        <i class="fas fa-bus text-lg"></i>
        <span>Add Bus</span>
      </button>
    </form>
  </div>

  <!-- Bus List Card -->
  <div class="rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-blue-100 rounded-xl p-3">
        <i class="fas fa-list text-blue-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Bus Fleet</h2>
    </div>
    
    <!-- Search Bar -->
    <div class="mb-6">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <i class="fas fa-search text-gray-400"></i>
        </div>
        <input type="text" id="searchBusFleet" placeholder="Search by bus number or route name..." 
               class="block w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
      </div>
    </div>
    
    <div class="overflow-x-auto rounded-xl border border-gray-200">
      <table class="min-w-full">
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Bus Number</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Route</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Departure</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Total Seats</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Available</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="busList" class="divide-y divide-gray-100">
          <tr>
            <td colspan="6" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center gap-3 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl"></i>
                <span class="text-sm font-medium">Loading buses...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

     <!-- Bus Assignments Section -->
<div id="assignmentsSection" class="section-content hidden space-y-8">
  <!-- Assignment Form Card -->
  <div class="rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-indigo-100 rounded-xl p-3">
        <i class="fas fa-user-plus text-indigo-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Assign Bus to Student</h2>
    </div>
    
    <form id="assignForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="studentSelect" class="block text-sm font-semibold text-gray-700 mb-2">Student</label>
          <select id="studentSelect" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" required>
            <option value="">Select Student</option>
          </select>
        </div>
        
        <div>
          <label for="busSelect" class="block text-sm font-semibold text-gray-700 mb-2">Bus</label>
          <select id="busSelect" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" required>
            <option value="">Select Bus</option>
          </select>
        </div>
      </div>
      
      <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-4 rounded-xl hover:from-indigo-700 hover:to-indigo-800 transition-all duration-300 flex items-center justify-center gap-3 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
        <i class="fas fa-tasks text-lg"></i>
        <span>Assign Bus</span>
      </button>
      
      <p id="assignMsg" class="text-green-600 font-semibold text-center"></p>
    </form>
  </div>

  <!-- Current Assignments Card -->
  <div class="rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-purple-100 rounded-xl p-3">
        <i class="fas fa-clipboard-list text-purple-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Current Assignments</h2>
    </div>
    
    <!-- Search and Filter Controls -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
      <div class="flex-1">
        <input id="searchStudent" type="text" placeholder="Search student name/email..." 
               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" />
      </div>
      <div class="md:w-64">
        <select id="filterBus" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
          <option value="">All Buses</option>
        </select>
      </div>
    </div>
    
    <!-- Assignments Table -->
    <div class="overflow-x-auto rounded-xl border border-gray-200">
      <table class="min-w-full">
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Student</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Assigned Bus</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Assigned On</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="assignmentList" class="divide-y divide-gray-100">
          <tr>
            <td colspan="4" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center gap-3 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl"></i>
                <span class="text-sm font-medium">Loading assignments...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

    <!-- Routes Management Section -->
<div id="routesSection" class="section-content hidden space-y-8">
  <!-- Add New Route Card -->
  <div class="rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-blue-100 rounded-xl p-3">
        <i class="fas fa-plus text-blue-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Add New Route</h2>
    </div>
    
    <form id="addRouteForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="routeName" class="block text-sm font-semibold text-gray-700 mb-2">Route Name</label>
          <input type="text" id="routeName" placeholder="Enter route name" required 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" />
        </div>
        <div>
          <label for="routeDescription" class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
          <input type="text" id="routeDescription" placeholder="Enter description" 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" />
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">Assign Stops (Order matters)</label>
        <div id="allStopsList" class="border border-gray-200 rounded-xl p-4 max-h-40 overflow-y-auto mb-4">
          <!-- All stops with checkboxes will be rendered here -->
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-600 mb-2">Assigned Stops (Drag to reorder or use up/down)</label>
          <ul id="assignedStopsList" class="border border-gray-200 rounded-xl p-4 min-h-[60px] bg-gray-50">
            <!-- Assigned stops will be rendered here -->
          </ul>
        </div>
      </div>
      
      <div id="addRouteMsg" class="text-sm text-red-500 font-medium"></div>
      
      <button type="submit" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 px-8 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
        Add Route
      </button>
    </form>
  </div>

  <!-- All Routes Card -->
  <div class="rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-green-100 rounded-xl p-3">
        <i class="fas fa-route text-green-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">All Routes</h2>
    </div>
    
    <div class="overflow-x-auto rounded-xl border border-gray-200">
      <table class="min-w-full">
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Name</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Description</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Stops (Ordered)</th>
            <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="routeList" class="divide-y divide-gray-100">
          <!-- Routes will be rendered here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Route Modal -->
<div id="editRouteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 relative transform transition-all max-h-[90vh] flex flex-col">
    <button id="closeEditRouteModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all z-10">&times;</button>
    
    <!-- Fixed Header -->
    <div class="flex items-center gap-3 p-8 pb-4 flex-shrink-0">
      <div class="bg-indigo-100 rounded-xl p-3">
        <i class="fas fa-edit text-indigo-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Edit Route</h2>
    </div>
    
    <!-- Scrollable Content -->
    <div class="px-8 flex-1 overflow-y-auto scrollbar-hide" style="scrollbar-width: none; -ms-overflow-style: none;">
      <form id="editRouteForm" class="space-y-6 pb-6">
        <div>
          <label for="editRouteName" class="block text-sm font-semibold text-gray-700 mb-2">Route Name</label>
          <input type="text" id="editRouteName" required 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" />
        </div>
        <div>
          <label for="editRouteDescription" class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
          <input type="text" id="editRouteDescription" 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" />
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-3">Assign Stops (Order matters)</label>
          <div id="editAllStopsList" class="border border-gray-200 rounded-xl p-4 max-h-40 overflow-y-auto mb-4 scrollbar-hide" style="scrollbar-width: none; -ms-overflow-style: none;">
            <!-- All stops with checkboxes will be rendered here -->
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-600 mb-2">Assigned Stops (Drag to reorder or use up/down)</label>
            <ul id="editAssignedStopsList" class="border border-gray-200 rounded-xl p-4 min-h-[60px] bg-gray-50 max-h-32 overflow-y-auto scrollbar-hide" style="scrollbar-width: none; -ms-overflow-style: none;">
              <!-- Assigned stops will be rendered here -->
            </ul>
          </div>
        </div>
        
        <div id="editRouteMsg" class="text-sm text-red-500 font-medium"></div>
      </form>
    </div>
    
    <!-- Fixed Footer -->
    <div class="p-8 pt-4 flex-shrink-0 border-t border-gray-100">
      <div class="flex gap-4">
        <button type="submit" form="editRouteForm" class="flex-1 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-3 rounded-xl hover:from-indigo-700 hover:to-indigo-800 transition-all duration-300 flex items-center justify-center gap-2 font-semibold shadow-lg">
          <i class="fas fa-save"></i>
          <span>Save Changes</span>
        </button>
        <button type="button" id="cancelEditRouteBtn" class="flex-1 border border-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-50 transition-all font-semibold">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

      <!-- Stops Management Section -->
<div id="stopsSection" class="section-content hidden space-y-8">
  <!-- Add New Stop Card -->
  <div class="rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-orange-100 rounded-xl p-3">
        <i class="fas fa-map-marker-alt text-orange-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Add New Stop</h2>
    </div>
    
    <form id="addStopForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="stopName" class="block text-sm font-semibold text-gray-700 mb-2">Stop Name</label>
          <input type="text" id="stopName" placeholder="Enter stop name" required 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all" />
        </div>
        <div>
          <label for="stopLocation" class="block text-sm font-semibold text-gray-700 mb-2">Location (lat,lng)</label>
          <input type="text" id="stopLocation" placeholder="e.g. 40.7128,-74.0060" 
                 class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all" />
        </div>
      </div>
      
      <div id="addStopMsg" class="text-sm text-red-500 font-medium"></div>
      
      <button type="submit" class="bg-gradient-to-r from-orange-600 to-orange-700 text-white py-4 px-8 rounded-xl hover:from-orange-700 hover:to-orange-800 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
        Add Stop
      </button>
    </form>
  </div>

  <!-- All Stops Card -->
  <div class="rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-teal-100 rounded-xl p-3">
        <i class="fas fa-list-ul text-teal-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">All Stops</h2>
    </div>
    
    <div class="overflow-x-auto rounded-xl border border-gray-200">
      <table class="min-w-full">
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Name</th>
            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Location</th>
            <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="stopsList" class="divide-y divide-gray-100">
          <!-- Stops will be rendered here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Stop Modal -->
<div id="editStopModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 relative transform transition-all">
    <button id="closeEditStopModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all">&times;</button>
    
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-purple-100 rounded-xl p-3">
        <i class="fas fa-edit text-purple-600 text-xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Edit Stop</h2>
    </div>
    
    <form id="editStopForm" class="space-y-6">
      <div>
        <label for="editStopName" class="block text-sm font-semibold text-gray-700 mb-2">Stop Name</label>
        <input type="text" id="editStopName" required 
               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" />
      </div>
      <div>
        <label for="editStopLocation" class="block text-sm font-semibold text-gray-700 mb-2">Location (lat,lng)</label>
        <input type="text" id="editStopLocation" 
               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" />
      </div>
      
      <div id="editStopMsg" class="text-sm text-red-500 font-medium"></div>
      
      <div class="flex gap-4">
        <button type="submit" class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 text-white py-3 rounded-xl hover:from-purple-700 hover:to-purple-800 transition-all duration-300 flex items-center justify-center gap-2 font-semibold shadow-lg">
          <i class="fas fa-save"></i>
          <span>Save Changes</span>
        </button>
        <button type="button" id="cancelEditStopBtn" class="flex-1 border border-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-50 transition-all font-semibold">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

      <!-- Feedback Section -->
      <div id="feedbackSection" class="section-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Student Feedback</h2>
          <div id="feedbackList" class="space-y-4">
            <div class="p-4 text-center text-gray-500">
              <i class="fas fa-spinner fa-spin"></i> Loading feedback...
            </div>
          </div>
        </div>
      </div>

      <!-- Notifications Section -->       
<div id="notificationsSection" class="section-content hidden">         
  <!-- Send Notification Card -->
  <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border border-gray-100 p-8 mb-8 relative overflow-hidden">
    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 rounded-full -translate-y-16 translate-x-16"></div>
    <div class="relative">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.828 7l6.586 6.586a2 2 0 002.828 0l6.586-6.586A2 2 0 0019.414 5H4.586A2 2 0 00.828 7z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Send Notification</h2>
      </div>

      <form id="sendNotificationForm" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Recipient Type -->
          <div class="space-y-2">
            <label for="notificationRecipientType" class="block text-sm font-semibold text-gray-700">Send To</label>
            <div class="relative">
              <select id="notificationRecipientType" required class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all duration-300 appearance-none">
                <option value="all">All Students</option>
                <option value="bus">All Students of a Bus</option>
                <option value="student">Single Student</option>
              </select>
              <svg class="absolute right-3 top-4 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>

          <!-- Bus Selection -->
          <div id="notificationBusField" class="space-y-2 hidden">
            <label for="notificationBusSelect" class="block text-sm font-semibold text-gray-700">Select Bus</label>
            <div class="relative">
              <select id="notificationBusSelect" class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all duration-300 appearance-none">
                <option value="">Select Bus</option>
              </select>
              <svg class="absolute right-3 top-4 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>

          <!-- Student Selection -->
          <div id="notificationStudentField" class="space-y-2 hidden">
            <label for="notificationStudentSelect" class="block text-sm font-semibold text-gray-700">Select Student</label>
            <div class="relative">
              <select id="notificationStudentSelect" class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all duration-300 appearance-none">
                <option value="">Select Student</option>
              </select>
              <svg class="absolute right-3 top-4 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Title -->
        <div class="space-y-2">
          <label for="notificationTitle" class="block text-sm font-semibold text-gray-700">Title</label>
          <input type="text" id="notificationTitle" required 
                 class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all duration-300"
                 placeholder="Enter notification title..." />
        </div>

        <!-- Message -->
        <div class="space-y-2">
          <label for="notificationMsg" class="block text-sm font-semibold text-gray-700">Message</label>
          <textarea id="notificationMsg" required rows="4"
                    class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all duration-300 resize-none"
                    placeholder="Type your message here..."></textarea>
        </div>

        <div id="notificationFormMsg" class="text-sm text-red-500 font-medium"></div>

        <button type="submit" class="group relative w-full md:w-auto px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-xl hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/30 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
          <span class="flex items-center justify-center gap-2">
            <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            Send Notification
          </span>
        </button>
      </form>
    </div>
  </div>

  <!-- All Notifications Card -->
  <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border border-gray-100 p-8 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-24 h-24 bg-gradient-to-br from-blue-500/10 to-cyan-500/10 rounded-full -translate-y-12 -translate-x-12"></div>
    <div class="relative">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.828 7l6.586 6.586a2 2 0 002.828 0l6.586-6.586A2 2 0 0019.414 5H4.586A2 2 0 00.828 7z" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">All Notifications</h2>
        </div>
        <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg border border-green-200">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span class="text-sm font-medium text-green-700">Live Updates</span>
        </div>
      </div>

      <div id="notificationList" class="space-y-4">
        <!-- Notifications will be rendered here -->
        <div class="text-center py-12">
          <div class="w-16 h-16 bg-gradient-to-r from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.828 7l6.586 6.586a2 2 0 002.828 0l6.586-6.586A2 2 0 0019.414 5H4.586A2 2 0 00.828 7z" />
            </svg>
          </div>
          <p class="text-gray-500 font-medium">No notifications sent yet</p>
          <p class="text-gray-400 text-sm mt-1">Your sent notifications will appear here</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Custom animations */
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .section-content:not(.hidden) {
    animation: slideInUp 0.6s ease-out;
  }

  /* Hover effects for form fields */
  input:focus, textarea:focus, select:focus {
    transform: translateY(-2px);
  }

  /* Button hover animation */
  button[type="submit"]:hover {
    box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
  }

  /* Custom scrollbar for textarea */
  textarea::-webkit-scrollbar {
    width: 6px;
  }

  textarea::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
  }

  textarea::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
  }

  textarea::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .grid.md\\:grid-cols-2 {
      grid-template-columns: 1fr;
    }
  }
</style>

      <!-- Student Management Section -->
<div id="studentsSection" class="section-content hidden">
  <!-- Add New Student Card -->
  <div class="bg-gradient-to-br from-white to-blue-50 rounded-2xl shadow-xl border border-blue-100 p-8 mb-8 relative overflow-hidden">
    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-indigo-500/10 rounded-full -translate-y-16 translate-x-16"></div>
    <div class="relative">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Add New Student</h2>
      </div>

      <form id="addStudentForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label for="studentName" class="block text-sm font-semibold text-gray-700">Full Name</label>
            <input type="text" id="studentName" placeholder="Enter full name" required 
                   class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all duration-300" />
          </div>
          
          <div class="space-y-2">
            <label for="studentEmail" class="block text-sm font-semibold text-gray-700">Email</label>
            <input type="email" id="studentEmail" placeholder="student@example.com" required 
                   class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all duration-300" />
          </div>
          
          <div class="space-y-2">
            <label for="studentPassword" class="block text-sm font-semibold text-gray-700">Password</label>
            <div class="relative">
              <input type="password" id="studentPassword" placeholder="Create password" required 
                     class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all duration-300 pr-12" />
              <button type="button" onclick="togglePassword('studentPassword')" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
            </div>
          </div>
          
          <div class="space-y-2">
            <label for="studentPhone" class="block text-sm font-semibold text-gray-700">Phone Number</label>
            <input type="tel" id="studentPhone" placeholder="+1 (555) 123-4567" 
                   class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all duration-300" />
          </div>
        </div>

        <div id="studentFormMsg" class="text-sm text-red-500 font-medium"></div>

        <button type="submit" class="group relative px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-blue-500/30 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
          <span class="flex items-center justify-center gap-2">
            <svg class="w-5 h-5 group-hover:rotate-12 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Add Student
          </span>
        </button>
      </form>
    </div>
  </div>

  <!-- All Students Card -->
  <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border border-gray-100 p-8 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-24 h-24 bg-gradient-to-br from-green-500/10 to-emerald-500/10 rounded-full -translate-y-12 -translate-x-12"></div>
    <div class="relative">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-2.196L19 12.5l-4.5 4.5" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">All Students</h2>
        </div>
        <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg border border-blue-200">
          <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
          <span class="text-sm font-medium text-blue-700">Real-time</span>
        </div>
      </div>

      <!-- Search and Filter Controls -->
      <div class="flex flex-col md:flex-row md:items-center md:space-x-4 mb-6">
        <div class="relative mb-4 md:mb-0 flex-1">
          <svg class="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input id="searchStudentMgmt" type="text" placeholder="Search by name or email..." 
                 class="pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl w-full focus:outline-none focus:border-green-500 focus:ring-4 focus:ring-green-500/20 transition-all duration-300" />
        </div>
        <div class="relative">
          <select id="filterStudentBus" class="px-4 py-3 border-2 border-gray-200 rounded-xl w-full md:w-64 focus:outline-none focus:border-green-500 focus:ring-4 focus:ring-green-500/20 transition-all duration-300 appearance-none bg-white">
            <option value="">All Buses</option>
          </select>
          <svg class="absolute right-3 top-4 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </div>

      <!-- Students Table -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Name
                  </div>
                </th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
                    </svg>
                    Email
                  </div>
                </th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                    Phone
                  </div>
                </th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                    </svg>
                    Assigned Bus
                  </div>
                </th>
                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 011-1h6a1 1 0 011 1v4h3a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9a2 2 0 012-2h3z" />
                    </svg>
                    Assigned On
                  </div>
                </th>
                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="studentMgmtList" class="bg-white divide-y divide-gray-200">
              <!-- Students will be rendered here -->
              <tr class="text-center">
                <td colspan="6" class="py-12">
                  <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-gray-100 to-gray-200 rounded-full flex items-center justify-center mb-4">
                      <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-2.196a4 4 0 00-1.33 6.37z" />
                      </svg>
                    </div>
                    <p class="text-gray-500 font-medium">No students found</p>
                    <p class="text-gray-400 text-sm mt-1">Add your first student to get started</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Details Modal -->
  <div id="studentDetailsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md relative transform transition-all duration-300 scale-95 opacity-0">
      <button id="closeStudentDetailsModal" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors duration-200">
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl flex items-center justify-center shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Student Details</h2>
      </div>
      
      <div id="studentDetailsContent" class="space-y-4">
        <!-- Student details will be rendered here -->
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
      <button id="closeEditStudentModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h2 class="text-xl font-semibold mb-4">Edit Student</h2>
      <form id="editStudentForm" class="space-y-4">
        <div>
          <label for="editStudentName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
          <input type="text" id="editStudentName" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
          <label for="editStudentEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="editStudentEmail" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
          <label for="editStudentPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
          <input type="text" id="editStudentPhone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
          <label for="editStudentBus" class="block text-sm font-medium text-gray-700 mb-1">Assigned Bus</label>
          <select id="editStudentBus" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            <option value="">None</option>
          </select>
        </div>
        <div id="editStudentMsg" class="text-sm text-red-500"></div>
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center space-x-2">
            <i class="fas fa-save"></i>
            <span>Save Changes</span>
          </button>
          <button type="button" id="cancelEditStudentBtn" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition">Cancel</button>
        </div>
      </form>
    </div>
  </div>

</div>

<style>
  /* Password toggle functionality */
  .password-visible {
    -webkit-text-security: none;
  }

  /* Modal animations */
  #studentDetailsModal:not(.hidden) .bg-white {
    animation: modalSlideIn 0.3s ease-out forwards;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Table row hover effects */
  tbody tr:hover {
    background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
    transform: translateX(4px);
    transition: all 0.2s ease;
  }

  /* Form field animations */
  input:focus, select:focus, textarea:focus {
    transform: translateY(-2px);
  }

  /* Custom scrollbar */
  .overflow-x-auto::-webkit-scrollbar {
    height: 6px;
  }

  .overflow-x-auto::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
  }

  .overflow-x-auto::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
  }

  .overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Button animations */
  button[type="submit"]:hover {
    box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .grid.md\\:grid-cols-2 {
      grid-template-columns: 1fr;
    }
    
    table th, table td {
      padding: 12px 16px;
    }
  }
</style>

<script>
  // Password visibility toggle function
  function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    const icon = button.querySelector('svg');
    
    if (input.type === 'password') {
      input.type = 'text';
      icon.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
      `;
    } else {
      input.type = 'password';
      icon.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
      `;
    }
  }

  // Modal show/hide functionality
  function showStudentModal() {
    const modal = document.getElementById('studentDetailsModal');
    modal.classList.remove('hidden');
    setTimeout(() => {
      const content = modal.querySelector('.bg-white');
      content.style.opacity = '1';
      content.style.transform = 'scale(1) translateY(0)';
    }, 10);
  }

  function hideStudentModal() {
    const modal = document.getElementById('studentDetailsModal');
    const content = modal.querySelector('.bg-white');
    content.style.opacity = '0';
    content.style.transform = 'scale(0.95) translateY(-20px)';
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }

  // Event listeners for modal
  document.getElementById('closeStudentDetailsModal').addEventListener('click', hideStudentModal);
  document.getElementById('studentDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
      hideStudentModal();
    }
  });

  // Section visibility animation
  document.addEventListener('DOMContentLoaded', function() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';
        }
      });
    });

    document.querySelectorAll('.bg-gradient-to-br').forEach(el => {
      el.style.opacity = '0';
      el.style.transform = 'translateY(30px)';
      el.style.transition = 'all 0.6s ease-out';
      observer.observe(el);
    });
  });
</script> 

  <!-- Firebase SDKs -->
  <script type="module">
    import { firebaseConfig } from './js/firebaseConfig.js';
    // â Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      deleteDoc,
      updateDoc,
      doc,
      setDoc,
      query,
      where,
      onSnapshot,
      orderBy,
      limit,
      deleteField
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // â Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let currentSection = 'dashboard';

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      setupNavigation();
      setupEventListeners();
      checkAuthState();
      populateStopsSelect('routeStops');

      // Bus Fleet Search functionality
      document.getElementById('searchBusFleet')?.addEventListener('input', fetchBuses);

      // Real-time Live Feedback Feed
      const liveFeedbackFeed = document.getElementById('liveFeedbackFeed');
      onSnapshot(query(collection(db, 'feedback'), orderBy('createdAt', 'desc'), limit(5)), (snapshot) => {
        liveFeedbackFeed.innerHTML = '';
        if (snapshot.empty) {
          liveFeedbackFeed.innerHTML = '<li class="text-gray-400 text-center">No feedback yet</li>';
          return;
        }
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          let time = '';
          if (data.createdAt && data.createdAt.toDate) {
            time = new Date(data.createdAt.toDate()).toLocaleTimeString();
          }
          liveFeedbackFeed.innerHTML += `<li><b>${data.studentName || data.email || 'Student'}</b>: ${data.message} <span class='text-xs text-gray-400'>${time}</span></li>`;
        });
      });

      // Real-time Live Notifications Feed
      const liveNotificationsFeed = document.getElementById('liveNotificationsFeed');
      onSnapshot(query(collection(db, 'notifications'), orderBy('createdAt', 'desc'), limit(5)), (snapshot) => {
        liveNotificationsFeed.innerHTML = '';
        if (snapshot.empty) {
          liveNotificationsFeed.innerHTML = '<li class="text-gray-400 text-center">No notifications yet</li>';
          return;
        }
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          let recipient = 'All';
          if (data.recipientType === 'bus') recipient = `Bus`;
          if (data.recipientType === 'student') recipient = 'Student';
          let time = '';
          if (data.createdAt && data.createdAt.toDate) {
            time = new Date(data.createdAt.toDate()).toLocaleTimeString();
          }
          liveNotificationsFeed.innerHTML += `<li><b>${data.title}</b> <span class='text-xs text-gray-400'>${time}</span><br/><span class='text-xs text-gray-500'>To: ${recipient}</span></li>`;
        });
      });
    });

    // Check authentication state
    function checkAuthState() {
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        // Fetch admin name from users collection
        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const data = userDoc.data();
            document.getElementById('adminName').textContent = data.name || 'Admin';
            document.getElementById('adminEmail').textContent = data.email || user.email;
          } else {
            document.getElementById('adminName').textContent = 'Admin';
            document.getElementById('adminEmail').textContent = user.email;
          }
        } catch (e) {
          document.getElementById('adminName').textContent = 'Admin';
          document.getElementById('adminEmail').textContent = user.email;
        }
        // Load initial data
        loadDashboardStats();
        loadUsers();
        fetchBuses();
        loadStudents();
        loadBuses();
        loadAssignments();
        loadFeedbacks();
        loadRoutes();
        loadRoutesToSelect();
        loadStops();
        loadNotifications();
      });
    }

    // Setup navigation
    function setupNavigation() {
      // Mobile menu toggle
      const mobileButton = document.getElementById('mobileMenuButton');
      console.log('Mobile button found:', mobileButton); // Debug log
      
      if (mobileButton) {
        mobileButton.addEventListener('click', function() {
          console.log('Mobile button clicked!'); // Debug log
          const sidebar = document.querySelector('.sidebar');
          console.log('Sidebar found:', sidebar); // Debug log
          console.log('Current classes:', sidebar.className); // Debug log
          sidebar.classList.toggle('active');
          console.log('After toggle classes:', sidebar.className); // Debug log
        });
      }

      // Close mobile menu when clicking outside
      document.addEventListener('click', function(e) {
        const sidebar = document.querySelector('.sidebar');
        const mobileButton = document.getElementById('mobileMenuButton');
        
        // Only on mobile screens
        if (window.innerWidth < 768) {
          if (!sidebar.contains(e.target) && e.target !== mobileButton && !mobileButton.contains(e.target)) {
            sidebar.classList.remove('active');
          }
        }
      });

      // Navigation links
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const section = this.getAttribute('href').substring(1);
          showSection(section);
          
          // Close mobile menu after navigation on mobile
          if (window.innerWidth < 768) {
            document.querySelector('.sidebar').classList.remove('active');
          }
        });
      });

      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        try {
          await signOut(auth);
          window.location.href = "login.html";
        } catch (error) {
          console.error("Logout error:", error);
        }
      });
    }

    // Show specific section
    function showSection(section) {
      // Hide all sections
      document.querySelectorAll('.section-content').forEach(el => {
        el.classList.add('hidden');
      });
      
      // Show selected section
      document.getElementById(`${section}Section`).classList.remove('hidden');
      
      // Update active nav link
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector(`.nav-link[href="#${section}"]`).classList.add('active');
      
      // Update title
      document.getElementById('sectionTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);
      
      currentSection = section;
      // Show/hide live feedback and notifications grid only on dashboard
      const liveGrid = document.getElementById('liveDashboardGrid');
      if (liveGrid) {
        if (section === 'dashboard') {
          liveGrid.classList.remove('hidden');
        } else {
          liveGrid.classList.add('hidden');
        }
      }
      // --- ADDED: Refresh stops select when showing routes section ---
      if (section === 'routes') {
        populateStopsSelect('routeStops');
      }
      if (section === 'notifications' && document.getElementById('notificationList')) {
        loadNotifications();
      }
      // --- ADDED: Load students when showing students section ---
      if (section === 'students') {
        renderAllStudents();
      }
    }

    // Setup event listeners for forms
    function setupEventListeners() {
      // User form
      document.getElementById('addUserForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('newName').value.trim();
        const email = document.getElementById('newEmail').value.trim();
        const password = document.getElementById('newPassword').value.trim();
        const role = document.getElementById('newRole').value;

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const uid = userCredential.user.uid;

          await setDoc(doc(db, "users", uid), {
            uid,
            name,
            email,
            role,
            createdAt: new Date()
          });

          document.getElementById('formMsg').textContent = "â User created successfully!";
          document.getElementById('addUserForm').reset();
          loadUsers();
          loadStudents();
          loadDashboardStats();
          
          setTimeout(() => {
            document.getElementById('formMsg').textContent = "";
          }, 3000);
        } catch (error) {
          document.getElementById('formMsg').textContent = `â ${error.message}`;
        }
      });

      // Bus form
      document.getElementById('busForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const busNumber = document.getElementById('busNumber').value.trim();
        const routeId = document.getElementById('busRouteSelect').value;
        const departure = document.getElementById('departure').value;
        const seatsTotal = parseInt(document.getElementById('seatsTotal').value);
        if (!routeId) {
          alert('Please select a route.');
          return;
        }
        try {
          await addDoc(collection(db, "buses"), {
            busNumber,
            route: routeId,
            departure,
            seatsTotal
          });
          document.getElementById('busForm').reset();
          fetchBuses();
          loadBuses();
          loadDashboardStats();
        } catch (err) {
          alert("â " + err.message);
        }
      });

      // Assignment form
      document.getElementById('assignForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const studentId = document.getElementById('studentSelect').value;
        const busId = document.getElementById('busSelect').value;
        if (!studentId || !busId) {
          document.getElementById('assignMsg').textContent = "â Select both student and bus.";
          return;
        }
        try {
          await updateDoc(doc(db, "students", studentId), {
            assignedBus: busId,
            assignedAt: new Date()
          });
          document.getElementById('assignMsg').textContent = "â Bus assigned successfully!";
          document.getElementById('assignForm').reset();
          loadAssignments();
          setTimeout(() => {
            document.getElementById('assignMsg').textContent = "";
          }, 3000);
        } catch (err) {
          document.getElementById('assignMsg').textContent = `â ${err.message}`;
        }
      });

      // Route form
      document.getElementById('addRouteForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('routeName').value.trim();
        const desc = document.getElementById('routeDescription').value.trim();
        if (!name) return;
        try {
          await addDoc(collection(db, "routes"), {
            name,
            description: desc,
            stops: assignedStops,
            createdAt: new Date()
          });
          document.getElementById('addRouteForm').reset();
          assignedStops = [];
          setupRouteStopsUI();
          loadRoutes();
          loadRoutesToSelect();
          loadDashboardStats();
        } catch (err) {
          alert("â Failed to add route: " + err.message);
        }
      });

      // Stop form
      document.getElementById('addStopForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const stopName = document.getElementById('stopName').value.trim();
        const location = document.getElementById('stopLocation').value.trim();
        if (!stopName || !location) {
          document.getElementById('addStopMsg').textContent = 'â Stop name and location are required.';
          return;
        }

        try {
          await addDoc(collection(db, "stops"), {
            stopName,
            location,
            createdAt: new Date()
          });
          document.getElementById('addStopForm').reset();
          loadStops();
        } catch (err) {
          alert("â Failed to add stop: " + err.message);
        }
      });

      // Notification form
      document.getElementById('sendNotificationForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const recipientType = document.getElementById('notificationRecipientType').value;
        const busId = document.getElementById('notificationBusSelect').value;
        const studentId = document.getElementById('notificationStudentSelect').value;
        const title = document.getElementById('notificationTitle').value.trim();
        const message = document.getElementById('notificationMsg').value.trim();
        const formMsg = document.getElementById('notificationFormMsg');
        formMsg.textContent = '';
        let recipientId = null;
        if (recipientType === 'bus' && !busId) {
          formMsg.textContent = 'Please select a bus.';
          return;
        }
        if (recipientType === 'student' && !studentId) {
          formMsg.textContent = 'Please select a student.';
          return;
        }
        if (recipientType === 'bus') recipientId = busId;
        if (recipientType === 'student') recipientId = studentId;
        try {
          await addDoc(collection(db, 'notifications'), {
            title,
            message,
            recipientType,
            recipientId: recipientId || null,
            createdAt: new Date()
          });
          document.getElementById('sendNotificationForm').reset();
          formMsg.textContent = 'â Notification sent!';
          loadNotifications();
          setTimeout(() => { formMsg.textContent = ''; }, 2000);
        } catch (err) {
          formMsg.textContent = 'â ' + err.message;
        }
      });

      // Student form
      document.getElementById('addStudentForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('studentName').value.trim();
        const email = document.getElementById('studentEmail').value.trim();
        const password = document.getElementById('studentPassword').value.trim();
        const phone = document.getElementById('studentPhone').value.trim();

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const uid = userCredential.user.uid;

          await setDoc(doc(db, "students", uid), {
            uid,
            name,
            email,
            phone,
            createdAt: new Date()
          });

          document.getElementById('studentFormMsg').textContent = "â Student created successfully!";
          document.getElementById('addStudentForm').reset();
          loadDashboardStats();
          setTimeout(() => {
            document.getElementById('studentFormMsg').textContent = "";
          }, 3000);
        } catch (error) {
          document.getElementById('studentFormMsg').textContent = `â ${error.message}`;
        }
      });
    }

    // --------------------------------------------
    // â Dashboard Functions
    // --------------------------------------------
    async function loadDashboardStats() {
      try {
        const [studentsSnapshot, busesSnapshot, routesSnapshot, feedbackSnapshot] = await Promise.all([
          getDocs(collection(db, "students")),
          getDocs(collection(db, "buses")),
          getDocs(collection(db, "routes")),
          getDocs(collection(db, "feedback"))
        ]);
        // Update dashboard stats
        document.getElementById('totalStudents').textContent = studentsSnapshot.size;
        document.getElementById('activeBuses').textContent = busesSnapshot.size;
        document.getElementById('totalRoutes').textContent = routesSnapshot.size;
        document.getElementById('newFeedback').textContent = feedbackSnapshot.size;
        // Load recent activity
        loadRecentActivity();
      } catch (error) {
        console.error("Error loading dashboard stats:", error);
      }
    }

    async function loadRecentActivity() {
      const activityList = document.getElementById('recentActivity');
      activityList.innerHTML = '<div class="p-3 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading activity...</div>';

      try {
        // Get the 5 most recent notifications
        const notificationsSnapshot = await getDocs(
          query(collection(db, "notifications"), orderBy("createdAt", "desc"), limit(5))
        );

        activityList.innerHTML = '';
        if (notificationsSnapshot.empty) {
          activityList.innerHTML = '<div class="p-3 text-center text-gray-500">No recent activity</div>';
          return;
        }

        notificationsSnapshot.forEach(doc => {
          const data = doc.data();
          const activityItem = document.createElement('div');
          activityItem.className = 'p-3 border-b border-gray-100 last:border-0';
          activityItem.innerHTML = `
            <div class="flex items-start space-x-3">
              <div class="p-2 rounded-full bg-blue-100 text-blue-600">
                <i class="fas fa-bell"></i>
              </div>
              <div>
                <p class="font-medium">${data.title}</p>
                <p class="text-sm text-gray-600">${data.message}</p>
                <p class="text-xs text-gray-400 mt-1">${new Date(data.createdAt.toDate()).toLocaleString()}</p>
              </div>
            </div>
          `;
          activityList.appendChild(activityItem);
        });
      } catch (error) {
        console.error("Error loading recent activity:", error);
        activityList.innerHTML = '<div class="p-3 text-center text-red-500">Failed to load activity</div>';
      }
    }

    // --------------------------------------------
    // â User Management Functions
    // --------------------------------------------
    async function loadUsers() {
      const userList = document.getElementById('userList');
      userList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading users...</td></tr>';

      try {
        const snapshot = await getDocs(collection(db, "users"));
        userList.innerHTML = '';

        if (snapshot.empty) {
          userList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
          return;
        }

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const row = document.createElement('tr');

    // --------------------------------------------
    // â Student Edit Modal Logic
    // --------------------------------------------
    function setupStudentEditModal() {
      // This function is no longer needed as we have a better implementation below
    }

    document.addEventListener('DOMContentLoaded', setupStudentEditModal);
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">${data.name || 'â'}</td>
            <td class="px-6 py-4 whitespace-nowrap">${data.email}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs rounded-full ${data.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                ${data.role}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-red-600 hover:text-red-900 deleteUser" data-id="${docSnap.id}">Delete</button>
            </td>
          `;
          userList.appendChild(row);
        });

        // Add event listeners to delete buttons
        document.querySelectorAll('.deleteUser').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this user?')) {
              try {
                // Note: In a real app, you would also delete the auth user
                await deleteDoc(doc(db, "users", btn.dataset.id));
                loadUsers();
                loadStudents();
                loadDashboardStats();
              } catch (error) {
                alert('Error deleting user: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        console.error("Error loading users:", error);
        userList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading users</td></tr>';
      }
    }

    // --------------------------------------------
    // â Bus Management Functions
    // --------------------------------------------
    async function fetchBuses() {
      const busList = document.getElementById('busList');
      busList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading buses...</td></tr>';
      try {
        // Fetch all buses, students, and routes
        const [busesSnap, studentsSnap, routesSnap] = await Promise.all([
          getDocs(collection(db, "buses")),
          getDocs(collection(db, "students")),
          getDocs(collection(db, "routes"))
        ]);
        // Build routeId to name map
        const routeMap = {};
        routesSnap.forEach(doc => { routeMap[doc.id] = doc.data().name; });
        // Count assigned students per bus
        const assignedCounts = {};
        studentsSnap.forEach(doc => {
          const student = doc.data();
          if (student.assignedBus) {
            assignedCounts[student.assignedBus] = (assignedCounts[student.assignedBus] || 0) + 1;
          }
        });
        busList.innerHTML = '';
        if (busesSnap.empty) {
          busList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No buses found</td></tr>';
          return;
        }

        // Get search term
        const searchTerm = (document.getElementById('searchBusFleet')?.value || '').toLowerCase();
        
        let filteredBuses = [];
        busesSnap.forEach(docSnap => {
          const bus = docSnap.data();
          const id = docSnap.id;
          const routeName = routeMap[bus.route] || '-';
          
          // Filter based on search term
          if (!searchTerm || 
              bus.busNumber.toLowerCase().includes(searchTerm) || 
              routeName.toLowerCase().includes(searchTerm)) {
            filteredBuses.push({ bus, id, routeName });
          }
        });

        if (filteredBuses.length === 0) {
          busList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No buses match your search</td></tr>';
          return;
        }

        // Sort buses by bus number (numerically)
        filteredBuses.sort((a, b) => {
          const busNumA = parseInt(a.bus.busNumber) || 0;
          const busNumB = parseInt(b.bus.busNumber) || 0;
          return busNumA - busNumB;
        });

        filteredBuses.forEach(({ bus, id, routeName }) => {
          const totalSeats = bus.seatsTotal || 0;
          const assigned = assignedCounts[id] || 0;
          const availableSeats = totalSeats - assigned;
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">${bus.busNumber}</td>
            <td class="px-6 py-4">${routeName}</td>
            <td class="px-6 py-4 whitespace-nowrap">${bus.departure || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">${totalSeats}</td>
            <td class="px-6 py-4 whitespace-nowrap">${availableSeats}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-indigo-600 hover:text-indigo-900 editBusBtn" data-id="${id}">Edit</button>
              <button class="text-red-600 hover:text-red-900 deleteBus" data-id="${id}">Delete</button>
            </td>
          `;
          busList.appendChild(row);
        });

        // Add event listeners to delete buttons
        document.querySelectorAll('.deleteBus').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this bus?')) {
              try {
                await deleteDoc(doc(db, "buses", btn.dataset.id));
                fetchBuses();
                loadBuses();
                loadDashboardStats();
              } catch (error) {
                alert('Error deleting bus: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        busList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading buses</td></tr>';
      }
    }

    // --------------------------------------------
    // â Bus Assignment Functions
    // --------------------------------------------
    async function loadStudents() {
      const studentSelect = document.getElementById('studentSelect');
      if (!studentSelect) return;
      
      studentSelect.innerHTML = '<option value="">Select Student</option>';
      
      try {
        const snapshot = await getDocs(collection(db, "students"));
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          studentSelect.innerHTML += `<option value="${docSnap.id}">${data.name || data.email}</option>`;
        });
      } catch (error) {
        console.error("Error loading students:", error);
      }
    }

    async function loadBuses() {
      const busSelect = document.getElementById('busSelect');
      if (!busSelect) return;
      
      busSelect.innerHTML = '<option value="">Select Bus</option>';
      
      try {
        const [busesSnap, routesSnap] = await Promise.all([
          getDocs(collection(db, "buses")),
          getDocs(collection(db, "routes"))
        ]);
        const routeMap = {};
        routesSnap.forEach(doc => { routeMap[doc.id] = doc.data().name; });
        busesSnap.forEach(docSnap => {
          const data = docSnap.data();
          const routeName = routeMap[data.route] || '';
          busSelect.innerHTML += `<option value="${docSnap.id}">Bus No ${data.busNumber} (${routeName})</option>`;
        });
      } catch (error) {
        console.error("Error loading buses:", error);
      }
    }

    async function loadAssignments() {
      const assignmentList = document.getElementById('assignmentList');
      if (!assignmentList) return;
      assignmentList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading assignments...</td></tr>';
      try {
        // Fetch all students and buses
        const [studentsSnap, busesSnap, routesSnap] = await Promise.all([
          getDocs(collection(db, "students")),
          getDocs(collection(db, "buses")),
          getDocs(collection(db, "routes"))
        ]);
        const buses = {};
        busesSnap.forEach(doc => { buses[doc.id] = doc.data(); });
        const routeMap = {};
        routesSnap.forEach(doc => { routeMap[doc.id] = doc.data().name; });
        // Get search/filter values
        const searchValue = (document.getElementById('searchStudent')?.value || '').toLowerCase();
        const filterBus = document.getElementById('filterBus')?.value || '';
        // Populate bus filter dropdown
        const filterBusSelect = document.getElementById('filterBus');
        if (filterBusSelect && filterBusSelect.options.length === 1) {
          busesSnap.forEach(doc => {
            const bus = doc.data();
            const routeName = routeMap[bus.route] || '';
            filterBusSelect.innerHTML += `<option value="${doc.id}">Bus No ${bus.busNumber} (${routeName})</option>`;
          });
        }
        // Filter and display assignments
        assignmentList.innerHTML = '';
        let found = false;
        studentsSnap.forEach(docSnap => {
          const student = docSnap.data();
          // Search/filter logic
          if (searchValue && !(student.name?.toLowerCase().includes(searchValue) || student.email?.toLowerCase().includes(searchValue))) return;
          if (filterBus && student.assignedBus !== filterBus) return;
          found = true;
          const bus = student.assignedBus ? buses[student.assignedBus] : null;
          const routeName = bus && bus.route ? routeMap[bus.route] : '';
          const assignedOn = student.assignedAt ? new Date(student.assignedAt.toDate ? student.assignedAt.toDate() : student.assignedAt).toLocaleString() : '-';
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <p class="font-medium">${student.name || student.email}</p>
              <p class="text-sm text-gray-500">${student.email}</p>
            </td>
            <td class="px-6 py-4">
              <p class="font-medium">${bus ? `Bus No ${bus.busNumber} (${routeName})` : '-'}</p>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${assignedOn}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-indigo-600 hover:text-indigo-900 editAssignment" data-id="${docSnap.id}">Edit</button>
            </td>
          `;
          assignmentList.appendChild(row);
        });
        if (!found) {
          assignmentList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No assignments found</td></tr>';
        }
        // Edit button logic
        document.querySelectorAll('.editAssignment').forEach(btn => {
          btn.addEventListener('click', () => {
            const studentId = btn.dataset.id;
            // Find current bus assignment for this student
            const row = btn.closest('tr');
            const busCell = row.querySelector('td:nth-child(2) p.font-medium');
            const currentBusNumber = busCell ? busCell.textContent : '';
            // Find busId by matching bus number (fallback)
            let currentBusId = '';
            for (const [id, bus] of Object.entries(buses)) {
              if (bus.busNumber === currentBusNumber) {
                currentBusId = id;
                break;
              }
            }
            showEditAssignmentModal(studentId, currentBusId);
          });
        });
      } catch (error) {
        assignmentList.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading assignments: ${error.message}</td></tr>`;
      }
    }
    // Add search/filter event listeners
    document.getElementById('searchStudent')?.addEventListener('input', loadAssignments);
    document.getElementById('filterBus')?.addEventListener('change', loadAssignments);

    // --------------------------------------------
    // â Route Management Functions
    // --------------------------------------------
    async function loadRoutes() {
      const routeList = document.getElementById('routeList');
      if (!routeList) return;
      routeList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading routes...</td></tr>';
      try {
        // Fetch all routes and stops
        const [routesSnap, stopsSnap] = await Promise.all([
          getDocs(collection(db, 'routes')),
          getDocs(collection(db, 'stops'))
        ]);
        // Build stop ID to name map
        const stopMap = {};
        stopsSnap.forEach(docSnap => { stopMap[docSnap.id] = docSnap.data().stopName; });
        routeList.innerHTML = '';
        if (routesSnap.empty) {
          routeList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No routes found</td></tr>';
          return;
        }
        routesSnap.forEach(docSnap => {
          const data = docSnap.data();
          const stopNames = (data.stops || []).map(id => stopMap[id] || 'Unknown').join(', ');
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap font-medium">${data.name}</td>
            <td class="px-6 py-4">${data.description || 'â'}</td>
            <td class="px-6 py-4 whitespace-nowrap">${stopNames}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-indigo-600 hover:text-indigo-900 editRouteBtn" data-id="${docSnap.id}">Edit</button>
              <button class="text-red-600 hover:text-red-900 deleteRoute" data-id="${docSnap.id}">Delete</button>
            </td>
          `;
          routeList.appendChild(row);
        });
        // Add event listeners to delete buttons
        document.querySelectorAll('.deleteRoute').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this route?')) {
              try {
                await deleteDoc(doc(db, "routes", btn.dataset.id));
                loadRoutes();
                loadRoutesToSelect();
                loadDashboardStats();
              } catch (error) {
                alert('Error deleting route: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        console.error("Error loading routes:", error);
        routeList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading routes</td></tr>';
      }
    }

    async function loadRoutesToSelect() {
      const routeSelect = document.getElementById('routeSelect');
      if (!routeSelect) return;
      
      routeSelect.innerHTML = '<option value="">Select Route</option>';
      
      try {
        const snapshot = await getDocs(collection(db, "routes"));
        snapshot.forEach(docSnap => {
          const { name } = docSnap.data();
          routeSelect.innerHTML += `<option value="${docSnap.id}">${name}</option>`;
        });
      } catch (error) {
        console.error("Error loading routes for select:", error);
      }
    }

    // --------------------------------------------
    // â Stop Management Functions
    // --------------------------------------------
    async function loadStops() {
      const stopsList = document.getElementById('stopsList');
      if (!stopsList) return;
      
      stopsList.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading stops...</td></tr>';

      try {
        const snapshot = await getDocs(collection(db, "stops"));
        stopsList.innerHTML = '';

        if (snapshot.empty) {
          stopsList.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No stops found</td></tr>';
          return;
        }

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">${data.stopName}</td>
            <td class="px-6 py-4 whitespace-nowrap">${data.location || 'â'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-indigo-600 hover:text-indigo-900 editStopBtn" data-id="${docSnap.id}">Edit</button>
              <button class="text-red-600 hover:text-red-900 deleteStop" data-id="${docSnap.id}">Delete</button>
            </td>
          `;
          stopsList.appendChild(row);
        });

        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.editStopBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const stopId = btn.dataset.id;
            getDoc(doc(db, 'stops', stopId)).then(docSnap => {
              if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('editStopName').value = data.stopName || '';
                document.getElementById('editStopLocation').value = data.location || '';
                document.getElementById('editStopMsg').textContent = '';
                document.getElementById('editStopModal').classList.remove('hidden');
              }
            });
          });
        });

        document.querySelectorAll('.deleteStop').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this stop?')) {
              try {
                await deleteDoc(doc(db, "stops", btn.dataset.id));
                loadStops();
              } catch (error) {
                alert('Error deleting stop: ' + error.message);
              }
            }
          });
        });
      } catch (error) {
        console.error("Error loading stops:", error);
        stopsList.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error loading stops</td></tr>';
      }
    }

    // --------------------------------------------
    // â Feedback Management Functions
    // --------------------------------------------
    async function loadFeedbacks() {
      const feedbackList = document.getElementById('feedbackList');
      if (!feedbackList) return;
      
      feedbackList.innerHTML = '<div class="p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading feedback...</div>';

      try {
        const snapshot = await getDocs(
          query(collection(db, "feedback"), orderBy("createdAt", "desc"))
        );
        feedbackList.innerHTML = '';

        if (snapshot.empty) {
          feedbackList.innerHTML = '<div class="p-4 text-center text-gray-500">No feedback yet</div>';
          return;
        }

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement('div');
          div.className = 'bg-white p-4 rounded shadow border border-gray-100 mb-4';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <h3 class="font-bold text-lg">${data.title || 'Feedback'}</h3>
              <span class="text-xs text-gray-500">${new Date(data.createdAt.toDate()).toLocaleString()}</span>
            </div>
            <p class="mt-2 text-gray-700">${data.message}</p>
            <div class="mt-3 flex flex-col md:flex-row md:justify-between md:items-center gap-2">
              <span class="text-sm text-gray-500">From: <span class="font-semibold">${data.studentName || '-'}</span> &lt;${data.email || '-'}&gt;</span>
              <span class="flex gap-2 mt-2 md:mt-0">
                <button class="replyFeedbackBtn bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs" data-id="${docSnap.id}" data-email="${data.email || ''}" data-name="${data.studentName || ''}"><i class="fas fa-reply"></i> Reply</button>
                <button class="deleteFeedbackBtn bg-red-100 text-red-700 px-3 py-1 rounded text-xs" data-id="${docSnap.id}"><i class="fas fa-trash"></i> Delete</button>
              </span>
            </div>
          `;
          feedbackList.appendChild(div);
        });
        // Add event listeners for delete and reply
        feedbackList.querySelectorAll('.deleteFeedbackBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this feedback?')) {
              try {
                await deleteDoc(doc(db, 'feedback', btn.dataset.id));
                loadFeedbacks();
              } catch (err) {
                alert('Error deleting feedback: ' + err.message);
              }
            }
          });
        });
        feedbackList.querySelectorAll('.replyFeedbackBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const email = btn.dataset.email;
            const name = btn.dataset.name;
            document.getElementById('replyFeedbackEmail').textContent = email;
            document.getElementById('replyFeedbackName').textContent = name;
            document.getElementById('replyFeedbackMsg').value = '';
            document.getElementById('replyFeedbackModal').classList.remove('hidden');
          });
        });
      } catch (error) {
        console.error("Error loading feedback:", error);
        feedbackList.innerHTML = '<div class="p-4 text-center text-red-500">Error loading feedback</div>';
      }
    }

    // --------------------------------------------
    // â Notification Management Functions
    // --------------------------------------------
    async function loadNotifications() {
      const notificationList = document.getElementById('notificationList');
      if (!notificationList) return;
      
      notificationList.innerHTML = '<div class="p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading notifications...</div>';

      try {
        const snapshot = await getDocs(
          query(collection(db, "notifications"), orderBy("createdAt", "desc"))
        );
        notificationList.innerHTML = '';

        if (snapshot.empty) {
          notificationList.innerHTML = '<div class="p-4 text-center text-gray-500">No notifications yet</div>';
          return;
        }

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement('div');
          div.className = 'bg-white p-4 rounded shadow border border-gray-100';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <h3 class="font-bold text-lg">${data.title}</h3>
              <span class="text-xs text-gray-500">${new Date(data.createdAt.toDate()).toLocaleString()}</span>
            </div>
            <p class="mt-2 text-gray-700">${data.message}</p>
            <div class="mt-3 flex justify-end">
              <button class="text-red-500 text-sm deleteNotification" data-id="${docSnap.id}">
                <i class="fas fa-trash mr-1"></i> Delete
              </button>
            </div>
          `;
          notificationList.appendChild(div);
        });

        // Add event listeners to delete buttons
        document.querySelectorAll('.deleteNotification').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this notification?')) {
              try {
                await deleteDoc(doc(db, "notifications", btn.dataset.id));
                loadNotifications();
                loadRecentActivity();
              } catch (error) {
                alert('Error deleting notification: ' + error.message);
              }
            }
          });
        });

        // Update notification badge
        const unreadCount = snapshot.size;
        const badge = document.getElementById('notificationBadge');
        if (badge) {
          if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      } catch (error) {
        console.error("Error loading notifications:", error);
        notificationList.innerHTML = '<div class="p-4 text-center text-red-500">Error loading notifications</div>';
      }
    }

    // Edit Assignment Modal Logic
    let currentAssignmentStudentId = null;
    function showEditAssignmentModal(studentId, currentBusId) {
      currentAssignmentStudentId = studentId;
      const modal = document.getElementById('editAssignmentModal');
      const busSelect = document.getElementById('editBusSelect');
      const msg = document.getElementById('editAssignmentMsg');
      msg.textContent = '';
      // Populate bus dropdown
      busSelect.innerHTML = '';
      getDocs(collection(db, 'buses')).then(snapshot => {
        snapshot.forEach(docSnap => {
          const bus = docSnap.data();
          const option = document.createElement('option');
          option.value = docSnap.id;
          option.textContent = `${bus.busNumber} (${bus.route})`;
          if (docSnap.id === currentBusId) option.selected = true;
          busSelect.appendChild(option);
        });
      });
      modal.classList.remove('hidden');
    }
    document.getElementById('closeEditModal').addEventListener('click', () => {
      document.getElementById('editAssignmentModal').classList.add('hidden');
    });
    document.getElementById('editAssignmentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const busId = document.getElementById('editBusSelect').value;
      const msg = document.getElementById('editAssignmentMsg');
      msg.textContent = '';
      if (!currentAssignmentStudentId || !busId) {
        msg.textContent = 'â Please select a bus.';
        return;
      }
      try {
        await updateDoc(doc(db, 'students', currentAssignmentStudentId), {
          assignedBus: busId,
          assignedAt: new Date()
        });
        msg.textContent = 'â Assignment updated!';
        setTimeout(() => {
          document.getElementById('editAssignmentModal').classList.add('hidden');
          loadAssignments();
        }, 1200);
      } catch (error) {
        msg.textContent = 'â ' + error.message;
      }
    });
    // Unassign Bus logic
    document.getElementById('unassignBusBtn').addEventListener('click', async () => {
      const msg = document.getElementById('editAssignmentMsg');
      msg.textContent = '';
      if (!currentAssignmentStudentId) {
        msg.textContent = 'â No student selected.';
        return;
      }
      try {
        await updateDoc(doc(db, 'students', currentAssignmentStudentId), {
          assignedBus: deleteField(),
          assignedAt: deleteField()
        });
        msg.textContent = 'â Bus unassigned!';
        setTimeout(() => {
          document.getElementById('editAssignmentModal').classList.add('hidden');
          loadAssignments();
        }, 1200);
      } catch (error) {
        msg.textContent = 'â ' + error.message;
      }
    });

    // Edit Bus Modal Logic
    let currentEditBusId = null;
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('editBusBtn')) {
        const busId = e.target.getAttribute('data-id');
        currentEditBusId = busId;
        // Fetch bus details from Firestore and pre-fill modal
        getDoc(doc(db, 'buses', busId)).then(async docSnap => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('editBusNumber').value = data.busNumber || '';
            document.getElementById('editDeparture').value = data.departure || '';
            document.getElementById('editSeatsTotal').value = data.seatsTotal || '';
            document.getElementById('editBusMsg').textContent = '';
            // Populate route dropdown and pre-select current route
            const select = document.getElementById('editBusRouteSelect');
            if (select) {
              select.innerHTML = '<option value="">Select Route</option>';
              const routesSnap = await getDocs(collection(db, 'routes'));
              routesSnap.forEach(routeDoc => {
                const option = document.createElement('option');
                option.value = routeDoc.id;
                option.textContent = routeDoc.data().name;
                if (routeDoc.id === data.route) option.selected = true;
                select.appendChild(option);
              });
            }
            document.getElementById('editBusModal').classList.remove('hidden');
          }
        });
      }
    });
    document.getElementById('editBusForm').onsubmit = async function(e) {
      e.preventDefault();
      if (!currentEditBusId) return;
      const busNumber = document.getElementById('editBusNumber').value.trim();
      const routeId = document.getElementById('editBusRouteSelect').value;
      const departure = document.getElementById('editDeparture').value;
      const seatsTotal = parseInt(document.getElementById('editSeatsTotal').value);
      try {
        await updateDoc(doc(db, 'buses', currentEditBusId), {
          busNumber,
          route: routeId,
          departure,
          seatsTotal
        });
        document.getElementById('editBusModal').classList.add('hidden');
        fetchBuses();
        loadBuses && loadBuses();
      } catch (err) {
        document.getElementById('editBusMsg').textContent = 'Failed to update bus.';
      }
    };

    // Edit Bus Modal close and cancel button handlers
    document.getElementById('closeEditBusModal').onclick = function() {
      document.getElementById('editBusModal').classList.add('hidden');
    };
    document.getElementById('cancelEditBusBtn').onclick = function() {
      document.getElementById('editBusModal').classList.add('hidden');
    };

    // Edit Stop Modal Logic
    let currentEditStopId = null;
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('editStopBtn')) {
        const stopId = e.target.dataset.id;
        currentEditStopId = stopId;
        getDoc(doc(db, 'stops', stopId)).then(docSnap => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('editStopName').value = data.stopName || '';
            document.getElementById('editStopLocation').value = data.location || '';
            document.getElementById('editStopMsg').textContent = '';
            document.getElementById('editStopModal').classList.remove('hidden');
          }
        });
      }
    });
    document.getElementById('closeEditStopModal').onclick = function() {
      document.getElementById('editStopModal').classList.add('hidden');
    };
    document.getElementById('cancelEditStopBtn').onclick = function() {
      document.getElementById('editStopModal').classList.add('hidden');
    };
    document.getElementById('editStopForm').onsubmit = async function(e) {
      e.preventDefault();
      if (!currentEditStopId) return;
      const stopName = document.getElementById('editStopName').value.trim();
      const location = document.getElementById('editStopLocation').value.trim();
      const msg = document.getElementById('editStopMsg');
      msg.textContent = '';
      if (!stopName || !location) {
        msg.textContent = 'â Stop name and location are required.';
        return;
      }
      try {
        await updateDoc(doc(db, 'stops', currentEditStopId), {
          stopName,
          location
        });
        document.getElementById('editStopModal').classList.add('hidden');
        loadStops();
      } catch (err) {
        msg.textContent = 'â Failed to update stop.';
      }
    };

    // Edit Route Modal Logic (add this before showing the modal)
    document.addEventListener('click', async function(e) {
      if (e.target.classList.contains('editRouteBtn')) {
        const routeId = e.target.getAttribute('data-id');
        // Fetch route details from Firestore and pre-fill modal
        const docSnap = await getDoc(doc(db, 'routes', routeId));
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('editRouteName').value = data.name || '';
          document.getElementById('editRouteDescription').value = data.description || '';
          // Set up assigned stops for edit
          editAssignedStops = Array.isArray(data.stops) ? [...data.stops] : [];
          await renderEditAllStopsList();
          renderEditAssignedStopsList();
          document.getElementById('editRouteMsg').textContent = '';
          document.getElementById('editRouteModal').classList.remove('hidden');
        }
      }
    });

    // --- Add this function near the top of your main <script> ---
    async function populateStopsSelect(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = '';
      try {
        const snapshot = await getDocs(collection(db, 'stops'));
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const option = document.createElement('option');
          option.value = docSnap.id;
          option.textContent = data.stopName;
          select.appendChild(option);
        });
      } catch (err) {
        select.innerHTML = '<option disabled>Error loading stops</option>';
      }
    }
    // --- Call on page load for add route form ---
    document.addEventListener('DOMContentLoaded', () => {
      populateStopsSelect('routeStops');
    });

    // --- Checkbox-based stop assignment logic ---
    let allStops = [];
    let assignedStops = [];

    async function renderAllStopsList() {
      const container = document.getElementById('allStopsList');
      if (!container) return;
      container.innerHTML = '<div class="text-gray-400 text-sm">Loading stops...</div>';
      try {
        const snapshot = await getDocs(collection(db, 'stops'));
        allStops = [];
        container.innerHTML = '';
        snapshot.forEach(docSnap => {
          const stop = { id: docSnap.id, name: docSnap.data().stopName };
          allStops.push(stop);
          const label = document.createElement('label');
          label.className = 'flex items-center space-x-2 mb-1';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = stop.id;
          checkbox.checked = assignedStops.includes(stop.id);
          checkbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              assignedStops.push(stop.id);
            } else {
              assignedStops = assignedStops.filter(id => id !== stop.id);
            }
            renderAssignedStopsList();
          });
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(stop.name));
          container.appendChild(label);
        });
      } catch (err) {
        container.innerHTML = '<div class="text-red-500 text-sm">Error loading stops</div>';
      }
    }

    function renderAssignedStopsList() {
      const ul = document.getElementById('assignedStopsList');
      if (!ul) return;
      ul.innerHTML = '';
      assignedStops.forEach((stopId, idx) => {
        const stop = allStops.find(s => s.id === stopId);
        if (!stop) return;
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between py-1 px-2 border-b last:border-0';
        li.innerHTML = `
          <span>${stop.name}</span>
          <span class="flex space-x-1">
            <button type="button" class="moveStopUpBtn text-xs px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" data-idx="${idx}">&#8593;</button>
            <button type="button" class="moveStopDownBtn text-xs px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" data-idx="${idx}">&#8595;</button>
            <button type="button" class="removeStopBtn text-xs px-2 py-1 bg-red-200 text-red-700 rounded hover:bg-red-300" data-idx="${idx}">Remove</button>
          </span>
        `;
        ul.appendChild(li);
      });
      // Add event listeners for up/down/remove
      ul.querySelectorAll('.moveStopUpBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          if (idx > 0) {
            [assignedStops[idx - 1], assignedStops[idx]] = [assignedStops[idx], assignedStops[idx - 1]];
            renderAssignedStopsList();
          }
        });
      });
      ul.querySelectorAll('.moveStopDownBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          if (idx < assignedStops.length - 1) {
            [assignedStops[idx + 1], assignedStops[idx]] = [assignedStops[idx], assignedStops[idx + 1]];
            renderAssignedStopsList();
          }
        });
      });
      ul.querySelectorAll('.removeStopBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          assignedStops.splice(idx, 1);
          renderAssignedStopsList();
          renderAllStopsList();
        });
      });
    }

    // On page load and when showing routes section
    async function setupRouteStopsUI() {
      assignedStops = [];
      await renderAllStopsList();
      renderAssignedStopsList();
    }
    // Call setupRouteStopsUI on page load and in showSection('routes')
    document.addEventListener('DOMContentLoaded', setupRouteStopsUI);

    // --- Edit Route Modal Logic ---
    let currentEditRouteId = null;
    document.addEventListener('click', async function(e) {
      if (e.target.classList.contains('editRouteBtn')) {
        const routeId = e.target.getAttribute('data-id');
        currentEditRouteId = routeId;
        // Fetch route details from Firestore and pre-fill modal
        const docSnap = await getDoc(doc(db, 'routes', routeId));
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('editRouteName').value = data.name || '';
          document.getElementById('editRouteDescription').value = data.description || '';
          // Set up assigned stops for edit
          editAssignedStops = Array.isArray(data.stops) ? [...data.stops] : [];
          await renderEditAllStopsList();
          renderEditAssignedStopsList();
          document.getElementById('editRouteMsg').textContent = '';
          document.getElementById('editRouteModal').classList.remove('hidden');
        }
      }
    });

    let editAllStops = [];
    let editAssignedStops = [];

    async function renderEditAllStopsList() {
      const container = document.getElementById('editAllStopsList');
      if (!container) return;
      container.innerHTML = '<div class="text-gray-400 text-sm">Loading stops...</div>';
      try {
        const snapshot = await getDocs(collection(db, 'stops'));
        editAllStops = [];
        container.innerHTML = '';
        snapshot.forEach(docSnap => {
          const stop = { id: docSnap.id, name: docSnap.data().stopName };
          editAllStops.push(stop);
          const label = document.createElement('label');
          label.className = 'flex items-center space-x-2 mb-1';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = stop.id;
          checkbox.checked = editAssignedStops.includes(stop.id);
          checkbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              editAssignedStops.push(stop.id);
            } else {
              editAssignedStops = editAssignedStops.filter(id => id !== stop.id);
            }
            renderEditAssignedStopsList();
          });
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(stop.name));
          container.appendChild(label);
        });
      } catch (err) {
        container.innerHTML = '<div class="text-red-500 text-sm">Error loading stops</div>';
      }
    }

    function renderEditAssignedStopsList() {
      const ul = document.getElementById('editAssignedStopsList');
      if (!ul) return;
      ul.innerHTML = '';
      editAssignedStops.forEach((stopId, idx) => {
        const stop = editAllStops.find(s => s.id === stopId);
        if (!stop) return;
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between py-1 px-2 border-b last:border-0';
        li.innerHTML = `
          <span>${stop.name}</span>
          <span class="flex space-x-1">
            <button type="button" class="editMoveStopUpBtn text-xs px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" data-idx="${idx}">&#8593;</button>
            <button type="button" class="editMoveStopDownBtn text-xs px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" data-idx="${idx}">&#8595;</button>
            <button type="button" class="editRemoveStopBtn text-xs px-2 py-1 bg-red-200 text-red-700 rounded hover:bg-red-300" data-idx="${idx}">Remove</button>
          </span>
        `;
        ul.appendChild(li);
      });
      // Add event listeners for up/down/remove
      ul.querySelectorAll('.editMoveStopUpBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          if (idx > 0) {
            [editAssignedStops[idx - 1], editAssignedStops[idx]] = [editAssignedStops[idx], editAssignedStops[idx - 1]];
            renderEditAssignedStopsList();
          }
        });
      });
      ul.querySelectorAll('.editMoveStopDownBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          if (idx < editAssignedStops.length - 1) {
            [editAssignedStops[idx + 1], editAssignedStops[idx]] = [editAssignedStops[idx], editAssignedStops[idx + 1]];
            renderEditAssignedStopsList();
          }
        });
      });
      ul.querySelectorAll('.editRemoveStopBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          editAssignedStops.splice(idx, 1);
          renderEditAssignedStopsList();
          renderEditAllStopsList();
        });
      });
    }

    document.getElementById('editRouteForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!currentEditRouteId) return;
      const name = document.getElementById('editRouteName').value.trim();
      const desc = document.getElementById('editRouteDescription').value.trim();
      if (!name) return;
      try {
        await updateDoc(doc(db, 'routes', currentEditRouteId), {
          name,
          description: desc,
          stops: editAssignedStops
        });
        document.getElementById('editRouteModal').classList.add('hidden');
        loadRoutes();
        loadRoutesToSelect();
        loadDashboardStats();
      } catch (err) {
        document.getElementById('editRouteMsg').textContent = 'â Failed to update route.';
      }
    });
    document.getElementById('closeEditRouteModal').onclick = function() {
      document.getElementById('editRouteModal').classList.add('hidden');
    };
    document.getElementById('cancelEditRouteBtn').onclick = function() {
      document.getElementById('editRouteModal').classList.add('hidden');
    };

    // Sidebar toggle logic (desktop only)
    const sidebar = document.querySelector('.sidebar');
    const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
    
    if (sidebarToggleBtn) {
      sidebarToggleBtn.addEventListener('click', () => {
        // Only work on desktop screens
        if (window.innerWidth >= 768) {
          sidebar.classList.toggle('closed');
          document.body.classList.toggle('sidebar-closed');
        }
      });
    }

    // Populate route dropdown in bus form
    async function populateBusRouteSelect() {
      const select = document.getElementById('busRouteSelect');
      if (!select) return;
      select.innerHTML = '<option value="">Select Route</option>';
      try {
        const snapshot = await getDocs(collection(db, 'routes'));
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const option = document.createElement('option');
          option.value = docSnap.id;
          option.textContent = data.name;
          select.appendChild(option);
        });
      } catch (err) {
        select.innerHTML = '<option disabled>Error loading routes</option>';
      }
    }
    document.addEventListener('DOMContentLoaded', populateBusRouteSelect);

    // Populate bus and student dropdowns for notifications
    async function populateNotificationBusSelect() {
      const select = document.getElementById('notificationBusSelect');
      if (!select) return;
      select.innerHTML = '<option value="">Select Bus</option>';
      try {
        // Fetch all buses and routes
        const [busesSnap, routesSnap] = await Promise.all([
          getDocs(collection(db, 'buses')),
          getDocs(collection(db, 'routes'))
        ]);
        // Build routeId to name map
        const routeMap = {};
        routesSnap.forEach(doc => { routeMap[doc.id] = doc.data().name; });
        busesSnap.forEach(docSnap => {
          const data = docSnap.data();
          const routeName = routeMap[data.route] || '';
          const option = document.createElement('option');
          option.value = docSnap.id;
          option.textContent = `Bus No ${data.busNumber} (${routeName})`;
          select.appendChild(option);
        });
      } catch (err) {
        select.innerHTML = '<option disabled>Error loading buses</option>';
      }
    }
    async function populateNotificationStudentSelect() {
      const select = document.getElementById('notificationStudentSelect');
      if (!select) return;
      select.innerHTML = '<option value="">Select Student</option>';
      try {
        const snapshot = await getDocs(collection(db, 'students'));
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const option = document.createElement('option');
          option.value = docSnap.id;
          option.textContent = `${data.name || data.email}`;
          select.appendChild(option);
        });
      } catch (err) {
        select.innerHTML = '<option disabled>Error loading students</option>';
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      populateNotificationBusSelect();
      populateNotificationStudentSelect();
    });
    // Show/hide fields based on recipient type
    const recipientTypeSelect = document.getElementById('notificationRecipientType');
    const busField = document.getElementById('notificationBusField');
    const studentField = document.getElementById('notificationStudentField');
    recipientTypeSelect.addEventListener('change', () => {
      if (recipientTypeSelect.value === 'bus') {
        busField.classList.remove('hidden');
        studentField.classList.add('hidden');
      } else if (recipientTypeSelect.value === 'student') {
        busField.classList.add('hidden');
        studentField.classList.remove('hidden');
      } else {
        busField.classList.add('hidden');
        studentField.classList.add('hidden');
      }
    });
    // Send notification form logic
    const sendNotificationForm = document.getElementById('sendNotificationForm');
    sendNotificationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const recipientType = recipientTypeSelect.value;
      const busId = document.getElementById('notificationBusSelect').value;
      const studentId = document.getElementById('notificationStudentSelect').value;
      const title = document.getElementById('notificationTitle').value.trim();
      const message = document.getElementById('notificationMsg').value.trim();
      const formMsg = document.getElementById('notificationFormMsg');
      formMsg.textContent = '';
      let recipientId = null;
      if (recipientType === 'bus' && !busId) {
        formMsg.textContent = 'Please select a bus.';
        return;
      }
      if (recipientType === 'student' && !studentId) {
        formMsg.textContent = 'Please select a student.';
        return;
      }
      if (recipientType === 'bus') recipientId = busId;
      if (recipientType === 'student') recipientId = studentId;
      try {
        await addDoc(collection(db, 'notifications'), {
          title,
          message,
          recipientType,
          recipientId: recipientId || null,
          createdAt: new Date()
        });
        document.getElementById('sendNotificationForm').reset();
        formMsg.textContent = 'â Notification sent!';
        loadNotifications();
        setTimeout(() => { formMsg.textContent = ''; }, 2000);
      } catch (err) {
        formMsg.textContent = 'â ' + err.message;
      }
    });

    // In Student Management, add JS logic to fetch and render students from the 'students' collection
    async function populateStudentBusFilter() {
      const select = document.getElementById('filterStudentBus');
      if (!select) return;
      select.innerHTML = '<option value="">All Buses</option>';
      try {
        const busesSnap = await getDocs(collection(db, 'buses'));
        const routesSnap = await getDocs(collection(db, 'routes'));
        const routeMap = {};
        routesSnap.forEach(doc => { routeMap[doc.id] = doc.data().name; });
        busesSnap.forEach(docSnap => {
          const data = docSnap.data();
          const routeName = routeMap[data.route] || '';
          const option = document.createElement('option');
          option.value = docSnap.id;
          option.textContent = `Bus No ${data.busNumber} (${routeName})`;
          select.appendChild(option);
        });
      } catch (err) {
        select.innerHTML = '<option disabled>Error loading buses</option>';
      }
    }
    async function renderAllStudents() {
      const tbody = document.getElementById('studentMgmtList');
      if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading students...</td></tr>';
      try {
        const [studentsSnap, busesSnap, routesSnap] = await Promise.all([
          getDocs(collection(db, 'students')),
          getDocs(collection(db, 'buses')),
          getDocs(collection(db, 'routes'))
        ]);
        const busMap = {};
        busesSnap.forEach(doc => busMap[doc.id] = doc.data());
        const routeMap = {};
        routesSnap.forEach(doc => routeMap[doc.id] = doc.data().name);
        const searchValue = (document.getElementById('searchStudentMgmt')?.value || '').toLowerCase();
        const filterBus = document.getElementById('filterStudentBus')?.value || '';
        tbody.innerHTML = '';
        let found = false;
        studentsSnap.forEach(docSnap => {
          const student = docSnap.data();
          if (searchValue && !(student.name?.toLowerCase().includes(searchValue) || student.email?.toLowerCase().includes(searchValue))) return;
          if (filterBus && student.assignedBus !== filterBus) return;
          found = true;
          const bus = student.assignedBus ? busMap[student.assignedBus] : null;
          const routeName = bus && bus.route ? routeMap[bus.route] : '';
          const assignedOn = student.assignedAt ? new Date(student.assignedAt.toDate ? student.assignedAt.toDate() : student.assignedAt).toLocaleString() : '-';
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">${student.name || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">${student.email || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">${student.phone || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">${bus ? `Bus No ${bus.busNumber} (${routeName})` : '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">${assignedOn}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-blue-600 hover:text-blue-900 viewStudentBtn" data-id="${docSnap.id}">View</button>
              <button class="text-green-600 hover:text-green-900 editStudentBtn" data-id="${docSnap.id}">Edit</button>
              <button class="text-red-600 hover:text-red-900 deleteStudentBtn" data-id="${docSnap.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        if (!found) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No students found</td></tr>';
        }
        // Add event listeners for view and delete
        tbody.querySelectorAll('.viewStudentBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const docSnap = await getDoc(doc(db, 'students', id));
            if (docSnap.exists()) {
              const s = docSnap.data();
              document.getElementById('studentDetailsContent').innerHTML = `
                <div><b>Name:</b> ${s.name || '-'}</div>
                <div><b>Email:</b> ${s.email || '-'}</div>
                <div><b>Phone:</b> ${s.phone || '-'}</div>
                <div><b>Assigned Bus:</b> ${s.assignedBus ? `Bus No ${busMap[s.assignedBus]?.busNumber || ''} (${routeMap[busMap[s.assignedBus]?.route] || ''})` : '-'}</div>
                <div><b>Assigned On:</b> ${s.assignedAt ? new Date(s.assignedAt.toDate ? s.assignedAt.toDate() : s.assignedAt).toLocaleString() : '-'}</div>
              `;
              document.getElementById('studentDetailsModal').classList.remove('hidden');
            }
          });
        });
        tbody.querySelectorAll('.deleteStudentBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this student?')) {
              try {
                await deleteDoc(doc(db, 'students', btn.dataset.id));
                renderAllStudents();
              } catch (err) {
                alert('Error deleting student: ' + err.message);
              }
            }
          });
        });
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading students</td></tr>';
      }
    }
    document.getElementById('closeStudentDetailsModal').onclick = function() {
      document.getElementById('studentDetailsModal').classList.add('hidden');
    };
    document.getElementById('searchStudentMgmt').addEventListener('input', renderAllStudents);
    document.getElementById('filterStudentBus').addEventListener('change', renderAllStudents);
    document.addEventListener('DOMContentLoaded', () => {
      populateStudentBusFilter();
      renderAllStudents();
    });

    // Edit Student Modal functionality
    let currentEditStudentId = null;

    // Attach Edit Student Modal logic
    document.getElementById('closeEditStudentModal').onclick = function() {
      document.getElementById('editStudentModal').classList.add('hidden');
    };
    document.getElementById('cancelEditStudentBtn').onclick = function() {
      document.getElementById('editStudentModal').classList.add('hidden');
    };
    document.getElementById('editStudentForm').onsubmit = async function(e) {
      e.preventDefault();
      if (!currentEditStudentId) return;
      const name = document.getElementById('editStudentName').value.trim();
      const email = document.getElementById('editStudentEmail').value.trim();
      const phone = document.getElementById('editStudentPhone').value.trim();
      const assignedBus = document.getElementById('editStudentBus').value;
      const msg = document.getElementById('editStudentMsg');
      msg.textContent = '';
      if (!name || !email) {
        msg.textContent = 'Name and email are required.';
        return;
      }
      try {
        await updateDoc(doc(db, 'students', currentEditStudentId), {
          name,
          email,
          phone,
          assignedBus: assignedBus || null
        });
        document.getElementById('editStudentModal').classList.add('hidden');
        renderAllStudents();
      } catch (err) {
        msg.textContent = 'â Failed to update student.';
      }
    };

    // Delegate editStudentBtn clicks
    document.body.addEventListener('click', async function(e) {
      if (e.target.classList.contains('editStudentBtn')) {
        const studentId = e.target.getAttribute('data-id');
        currentEditStudentId = studentId;
        // Fetch student details
        const docSnap = await getDoc(doc(db, 'students', studentId));
        if (docSnap.exists()) {
          const s = docSnap.data();
          document.getElementById('editStudentName').value = s.name || '';
          document.getElementById('editStudentEmail').value = s.email || '';
          document.getElementById('editStudentPhone').value = s.phone || '';
          // Populate bus dropdown
          const select = document.getElementById('editStudentBus');
          select.innerHTML = '<option value="">None</option>';
          const busesSnap = await getDocs(collection(db, 'buses'));
          const routesSnap = await getDocs(collection(db, 'routes'));
          const routeMap = {};
          routesSnap.forEach(doc => { routeMap[doc.id] = doc.data().name; });
          busesSnap.forEach(busDoc => {
            const bus = busDoc.data();
            const routeName = routeMap[bus.route] || '';
            const option = document.createElement('option');
            option.value = busDoc.id;
            option.textContent = `Bus No ${bus.busNumber} (${routeName})`;
            if (busDoc.id === s.assignedBus) option.selected = true;
            select.appendChild(option);
          });
          document.getElementById('editStudentMsg').textContent = '';
          document.getElementById('editStudentModal').classList.remove('hidden');
        }
      }
    });

  </script>
  <!-- Edit Assignment Modal -->
  <div id="editAssignmentModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
      <button id="closeEditModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h2 class="text-xl font-semibold mb-4">Edit Bus Assignment</h2>
      <form id="editAssignmentForm" class="space-y-4">
        <div>
          <label for="editBusSelect" class="block text-sm font-medium text-gray-700 mb-1">Select New Bus</label>
          <select id="editBusSelect" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></select>
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center space-x-2">
            <i class="fas fa-save"></i>
            <span>Save Changes</span>
          </button>
          <button id="unassignBusBtn" type="button" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition flex items-center justify-center space-x-2">
            <i class="fas fa-times-circle"></i>
            <span>Unassign Bus</span>
          </button>
        </div>
        <p id="editAssignmentMsg" class="text-green-600 font-semibold text-center"></p>
      </form>
    </div>
  </div>
  <!-- Edit Bus Modal -->
  <div id="editBusModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
      <button id="closeEditBusModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h2 class="text-xl font-semibold mb-4">Edit Bus</h2>
      <form id="editBusForm" class="space-y-4">
        <div>
          <label for="editBusNumber" class="block text-sm font-medium text-gray-700 mb-1">Bus Number</label>
          <input type="text" id="editBusNumber" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
          <label for="editBusRouteSelect" class="block text-sm font-medium text-gray-700 mb-1">Route</label>
          <select id="editBusRouteSelect" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            <option value="">Select Route</option>
            <!-- Route options will be populated by JS -->
          </select>
        </div>
        <div>
          <label for="editDeparture" class="block text-sm font-medium text-gray-700 mb-1">Departure Time</label>
          <input type="time" id="editDeparture" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
          <label for="editSeatsTotal" class="block text-sm font-medium text-gray-700 mb-1">Total Seats</label>
          <input type="number" id="editSeatsTotal" min="1" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div id="editBusMsg" class="text-sm text-red-500"></div>
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center space-x-2">
            <i class="fas fa-save"></i>
            <span>Save Changes</span>
          </button>
          <button type="button" id="cancelEditBusBtn" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Add Reply Feedback Modal HTML just before </body> -->
  <div id="replyFeedbackModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
      <button id="closeReplyFeedbackModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      <h2 class="text-xl font-semibold mb-4">Reply to Feedback</h2>
      <form id="replyFeedbackForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
          <div class="bg-gray-100 rounded px-3 py-2"><span id="replyFeedbackName"></span> &lt;<span id="replyFeedbackEmail"></span>&gt;</div>
        </div>
        <div>
          <label for="replyFeedbackMsg" class="block text-sm font-medium text-gray-700 mb-1">Message</label>
          <textarea id="replyFeedbackMsg" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" rows="4"></textarea>
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center space-x-2">
            <i class="fas fa-paper-plane"></i>
            <span>Send Reply</span>
          </button>
          <button type="button" id="cancelReplyFeedbackBtn" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <script>
  // ... existing code ...
  document.getElementById('closeReplyFeedbackModal').onclick = function() {
    document.getElementById('replyFeedbackModal').classList.add('hidden');
  };
  document.getElementById('cancelReplyFeedbackBtn').onclick = function() {
    document.getElementById('replyFeedbackModal').classList.add('hidden');
  };
  document.getElementById('replyFeedbackForm').onsubmit = function(e) {
    e.preventDefault();
    // UI only: just close the modal and show a success message
    document.getElementById('replyFeedbackModal').classList.add('hidden');
    alert('Reply sent! (UI only, no email logic implemented)');
  };
  // ... existing code ...
  </script>
</body>
</html>
</body>
</html>